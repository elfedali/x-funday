<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>x-funday</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&display=swap");
    </style>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <style>
      :root,
      [data-bs-theme="light"] {
        --bs-font-sans-serif: "Playfair Display", serif;
        --bs-body-font-size: 1.5rem;
        --bs-body-bg: #f8f8f8;
      }

      #messages {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }

      #messages > li {
        padding: 0.5rem 1rem;
      }

      #messages > li:nth-child(odd) {
        background: #efefef;
      }
    </style>
  </head>

  <body>
    <h1>Welcome, <%= user.username %>!</h1>
    <p>Your email is: <%= user.email %></p>
    <div id="welcomeMessage"></div>
    <!-- /#welcomeMessage -->
    <div>
      <!-- logout -->
      <a href="/logout">Logout</a>
    </div>
    <div class="conainer-fluid">
      <div class="row">
        <div class="col-8 mx-auto">
          <!--  -->
          <ul id="messages"></ul>
          <form action="" id="form">
            <div class="input-group mb-3">
              <input
                type="text"
                id="input"
                class="form-control"
                autocomplete="off"
              />
              <button class="btn btn-outline-secondary" type="submit">
                Send Message
              </button>
            </div>
          </form>
          <!--  -->
        </div>
        <!-- /.col-8 -->
      </div>
      <!-- /.row -->

      <div class="row">
        <div class="col-12 text-center my-4">
          <p>
            This is a simple chat application using
            <a href="https://socket.io/">socket.io</a> and
            <a href="https://getbootstrap.com/">bootstrap</a>
          </p>
        </div>
        <!-- /.col-12 -->
      </div>
      <!-- /.row -->
    </div>
    <!-- /.conainer-fluid -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io({
        auth: {
          serverOffset: 0,
        },
      });

      const form = document.getElementById("form");
      const input = document.getElementById("input");
      const messages = document.getElementById("messages");

      form.addEventListener("submit", (e) => {
        e.preventDefault();
        if (input.value) {
          socket.emit("chat message", input.value);
          form.reset();
        }
      });
      let currentUser; // Variable to store the current user  information
      // listen for the  event  "user" event to get the current user information
      socket.on("user", (user) => {
        currentUser = user;
        document.getElementById(
          "welcomeMessage"
        ).textContent = `Welcome, ${user.username}!`;
      });

      // listen for the  event  "chat message"
      socket.on("chat message", (messageData, serverOffset) => {
        console.log(messageData);
        const item = document.createElement("li");
        const usernameSpan = document.createElement("span");
        usernameSpan.classList.add("username"); // Optional class for styling
        usernameSpan.textContent = `[${messageData.username}] `;
        const messageSpan = document.createElement("span");
        messageSpan.textContent = messageData.content;
        item.appendChild(usernameSpan);
        item.appendChild(messageSpan);
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
        socket.auth.serverOffset = serverOffset;
      });
    </script>
  </body>
</html>
